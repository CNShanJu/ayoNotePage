# 中央处理器

**`中央处理器`**（central processing unit，简称`CPU`）作为计算机系统的**`运算`**和**`控制`**核心，是`信息处理`、`程序运行`的`最终执行单元`(它的功能主要是`解释计算机指令`以及`处理计算机软件中的数据`)。

中央处理器主要包括两个部分，即**`控制器`**、**`运算器`**，其中还包括`高速缓冲存储器`及实现它们之间`联系的数据`、`控制的总线`。**电子计算机**三大核心部件就是`CPU`、`内部存储器`、`输入/输出设备`。中央处理器的功效主要为**`处理指令`**、**`执行操作`**、**`控制时间`**、**`处理数据`**。

> 每次回家开灯时你有没有想过，用你按的开关实际上能打造出 复杂的 CPU来，只不过需要的数量可 能比较多，也就几十亿个吧。

## 工作原理

**`冯诺依曼体系结构`**是**现代计算机的基础**。在该体系结构下，**程序**和**数据**`统一存储`，**指令**和**数据**需要从`同一存储空间存取`，经由`同一总线传输`，==**无法重叠执行**==。

### 流程

根据**`冯诺依曼体系`**，CPU的工作分为以下 5 个阶段：**取指令阶段**、**指令译码阶段**、**执行指令阶段**、**访存取数**和**结果写回**。

1. ==**`取指令`**==（IF，instruction fetch）

   即将**一条指令**从`主存储器`中取到`指令寄存器`的过程。`程序计数器`中的**数值**，用来**指示`当前指令`在`主存`中的`位置`**。当 `一条指令`被取出后，`程序计数器`（PC）中的**数值**将根据`指令字长度`**自动递增**。

   

2. ==**`指令译码阶段`**==（ID，instruction decode）

   **取出指令后**，`指令译码器`按照**预定的**`指令格式`，对**取回的指令**进行**`拆分`**和**`解释`**，**识别区分**出`不同的指令类别`以及各种`获取操作数的方法`。现代`CISC`处理器会将拆分已提高并行率和效率。

   > `复杂指令集计算机`，Complex Instruction Set Computer。简称`CISC`

   

3. ==**`执行指令阶段`**==（EX，execute）

   **具体实现指令的功能**。CPU的不同部分被连接起来，以执行所需的操作。

   

4. **`访存取数阶段`**（MEM，memory）

   根据**`指令需要`** ***访问主存***、***读取操作数***，`CPU`得到`操作数`在`主存`中的`地址`，并从`主存`中`读取该操作数`**用于运算**。部分`指令` `不需要` ***访问主存***，则可以`跳过`该阶段。

    

5. ==**`结果写回阶段`**==（WB，write back）

   作为最后一个阶段，`结果写回`阶段把==`执行指令阶段`==的`运行结果数据`“**`写回`**”到**某种存储形式**。**`结果数据`一般会被写到`CPU的内部寄存器`中，以便被后续的`指令`快速地存取**；许多`指令`还会改变`程序状态字寄存器`中**标志位**的状态，这些**标志位** `标识着不同的操作结果`，可被用来`影响程序的动作`。 

   

6. 在==*指令执行完毕*==、==*结果数据写回*==之后，**若无意外事件（如`结果溢出`等）发生**，计算机就从`程序计数器`中取得下一条指令地址，开始新一轮的循环，下一个指令周期将顺序取出下一条指令。

   > 许多复杂的CPU可以一次提取多个指令、解码，并且同时执行。

> **小结**
>
> `CPU`的内部结构可分为`控制单元`，`逻辑单元`和`存储单元`三大部分。
>
> 
>
> `CPU`的**工作原理**就象一个**工厂对产品的加工过程**：
>
> 1. 进入工厂的原料（`指令`），
> 2. 经过物资分配部门（`控制单元`）的调度分配，
> 3. 被送往生产线（`逻辑运算单元`）。
> 4. 生产出成品（`处理后的数据`）后，
> 5. 再存储在仓库（`存储器`）中，
> 6. 最后等着拿到市场上去卖（`交由应用程序使用`）。

## 伟大的发明"晶体管"

### 前言

**`晶体管`**（transistor）是一种固体**半导体**器件（包括`二极管`、`三极管`、`场效应管`、`晶闸管`等，有时特指`双极型器件`），具有**检波**、**整流**、**放大**、**开关**、**稳压**、**信号调制**等多种功能。**`晶体管`**作为一种**`可变电流开关`**，能够**基于`输入`电压控制`输出`电流**。与普通机械开关（如Relay、switch）不同，**`晶体管`利用`电信号`来控制自身的`开合`**，所以开关速度可以非常快，实验室中的切换速度可达100GHz以上。

> **频率**的单位是`赫兹`，简称`赫`，以符号“`Hz`”表示。
>
> **频率**是指`电脉冲`，`交流电波形`，`电磁波`，`声波`和`机械的振动`**周期循环**时，**1秒钟重复的次数**。
>
> ==1Hz代表每秒钟周期震动1次(一秒钟内电流往返1次)，60Hz代表每秒周期震动60次。==
>
> 常用的频率单位有`千赫`(KHz)、`兆赫`、`吉赫`(**GHz**)等
>
> `千兆赫兹`(十亿赫兹)，简写为“`GHz`”，其中`G`指的是`giga(吉)`

### 伟大的发明

过去200年人类最重要的发明是什么？蒸汽机？电灯？火箭？这些可能都不是，最重要的也许是这小东西：

![1.你管这破玩意叫CPU？ - 图1](CPU图片/1_1-16658321232532.jpg)

这个小东西就叫`晶体管`，你可能会问，`晶体管`有什么用呢？

实际上晶体管的功能简单到不能再简单，给**一端通上电，那么电流可以从另外两端通过，否则不能通过**，其**本质就是一个`开关`**。

就是这个小东西的发明让三个人获得了诺贝尔物理学奖，可见其举足轻重的地位。

**无论程序员编写的程序多么复杂，软件承载的功能最终都是通过这个小东西简单的开闭完成的**，除了神奇二字，我想不出其它词来。

### AND、 OR、 NOT

现在有了`晶体管`，也就是`开关`，在此基础之上就可以搭积木了，你随手搭建出来这样**三种组合**：

- **两个开关**只有`同时打开`电流才会`通过`，灯才会亮
- **两个开关**中`只要有一个打开`电流就能`通过`，灯就会亮
- 当开关`关闭`时电流`通过`灯会亮，`打开`开关灯反而电流`不能通过`灯会灭

天赋异禀的你搭建的上述组合分别就是：**`与门`**，AND Gate、**`或门`**，OR gate、**`非门`**，NOT gate，用符号表示就是这样：

![1.你管这破玩意叫CPU？ - 图2](CPU图片/1_2.jpg)

### 道生一、一生二、二生三、三生万物

最神奇的是，你随手搭建的三种电路竟然有一种很amazing的特性，那就是：**任何一个`逻辑函数`最终都可以通过`AND`、`OR`以及`NOT` `表达`出来**，这就是所谓的**`逻辑完备性`**，就是这么神奇。

也就是说**给定足够的AND、OR以及NOT门，就可以实现任何一个逻辑函数，除此之外我们不需要任何其它类型的逻辑门电路**，这时我们认为{AND、OR、NOT}就是逻辑完备的。

这一结论的得出吹响了计算机革命的号角，这个结论告诉我们计算机最终可以通过简单的{AND、 OR、NOT}门构造出来，就好比基因。

![1.你管这破玩意叫CPU？ - 图3](CPU图片/1_3.jpg)

老子有云：道生一、一生二、二生三、三生万物，实乃异曲同工之妙。

虽然，我们可以用{AND、OR、NOT}来实现所有的逻辑运算，但我们真的需要把所有的逻辑运算都用 {AND、OR、NOT}们实现出来吗？显然不是，而且这也不太可行。

### 计算能力是怎么来的

现在能生成万物的基础元素与或非门出现了，接下来我们着手设计**CPU 最重要的能力：`计算`**，以加法为例。

由于**`CPU`只认知 `0 `和` 1`**，也就是`二进制`，那么二进制的加法有哪些组合呢：

> - 0 + 0，结果为0，进位为0
> - 0 + 1，结果为1，进位为0
> - 1 + 0，结果为1，进位为0
> - 1 + 1，结果为0，进位为1，二进制嘛！

注意进位一列，只有当两路输入的值都是 1 时，进位才是 1 ，看一下你设计的三种组合电路，这就是与门啊，有没有！

再看下结果一列，当两路输入的值不同时结果为1，输入结果相同时结果为0，这就是异或啊，有没有！我们说过与或非门是逻辑完备可以生万物的，异或逻辑当然不在话下，用一个与门和一个异或门就可以实现二进制加法：

![1.你管这破玩意叫CPU？ - 图4](CPU图片/1_4.jpg)

上述电路就是一个**简单的加法器**，就问你神奇不神奇，加法可以实现，其它的也一样能用与或非门实 现，逻辑完备嘛。

根据需要可以将不同的算数运算设计出来，这就是所谓的arithmetic/logic unit，ALU，CPU 中专门负责运算的模块，本质上和上面的简单电路没什么区别，就是更加复杂而已。

现在，通过与或非门的组合我们获得了计算能力。

但，只有计算能力是不够的，电路需要能**记得住**信息。

### 神奇的记忆能力

到目前为止，你设计的组合电路比如加法器天生是没有办法存储信息的，它们只是简单的根据输入得出输出，但输入输出总的有个地方能够保存起来，这就是需要电路能保存信息。

电路怎么能保存信息呢？你不知道该怎么设计，这个问题解决不了你寝食难安，吃饭时在思考、走路时在思考，蹲坑时在思考，直到有一天你在梦中遇一位英国物理学家，他给了你这样一个简单但极其神奇的电路，因为这个电路有记忆功能：

![1.你管这破玩意叫CPU？ - 图5](CPU图片/1_5.jpg)

这是两个NAND门的组合，不要紧张，NAND也是有你设计的与或非门组合而成的，所谓NAND门就是与非门，先与然后取非，比如给定输入1和0，那么与运算后为0，非运算后为1，这就是与非门，这些不重要。

> 与非门（[英语](https://baike.baidu.com/item/英语/109997?fromModule=lemma_inlink):NAND gate）是[数字电路](https://baike.baidu.com/item/数字电路/1705?fromModule=lemma_inlink)的一种基本[逻辑电路](https://baike.baidu.com/item/逻辑电路/446127?fromModule=lemma_inlink)。是与门和非门的叠加，有多个输入和一个输出。 [1] 
>
> 若当[输入](https://baike.baidu.com/item/输入/5481954?fromModule=lemma_inlink)均为[高电平](https://baike.baidu.com/item/高电平/9753092?fromModule=lemma_inlink)（1），则输出为低电平（0）；若输入中至少有一个为[低电平](https://baike.baidu.com/item/低电平/6946314?fromModule=lemma_inlink)（0），则输出为高电平（1）。与非门可以看作是[与门](https://baike.baidu.com/item/与门?fromModule=lemma_inlink)和[非门](https://baike.baidu.com/item/非门/1421165?fromModule=lemma_inlink)的[叠加](https://baike.baidu.com/item/叠加/5165814?fromModule=lemma_inlink)。 [1] 

比较独特的是该电路的组合方式，**一个NAND门的输出是多个NAND门的输入**，该电路的组合方式会生成一种很有趣的特性，**只要给S和R段输入1，那么这个电路只会有两种状态:**

> - 要么a端为1，此时B=0、A=1、b=0；
> - 要么a端为0，此时B=1、A=0、b=1;

不会再有其他可能了，**我们把a端的值作为电路的输出**。

此后，如果你把S端置为0的话(R保持为1)，那么电路的输出也就是a端永远为1，这时就可以说我们把1存到电路中了；而如果你把R段置为0的话(S保持为1)，那么电路的输出也就是a端永远为0，此时我们可以说把0存到电路中了。

就问你神奇不神奇，电路竟然具备了信息存储能力。

现在为保存信息你需要同时设置S端和R端，但你的输入是有一个，为此你对电路进行了简单的改造：

![1.你管这破玩意叫CPU？ - 图6](CPU图片/1_6.jpg)

这样，当D为0时，整个电路保存的就是0，否则就是1。

这正是我们想要的。

### 寄存器与内存的诞生

现在你的电路能存储一个比特位了，想存储多个还不简单，简单的组合即可：

![1.你管这破玩意叫CPU？ - 图7](CPU图片/1_7.jpg)

我们管这个组合电路就叫**寄存器**，你没有看错，我们常说的寄存器就是这个东西。

你不满足，还要继续搭建更加复杂的电路以存储更多信息，同时提供寻址功能，就这样**内存**也诞生了。

寄存器、内存都离不开上一节那个简单电路，只要通电，这个电路中就保存信息，但是断点后保存的信息就丢掉了，**现在你应该明白为什么内存在断电后信息就丢了吧**。

### 硬件还是软件

现在我们可以计算、也可以存储，但现在还有一个问题，那就是尽管我们可以用{AND、OR、NOT}表达出所有的逻辑函数，但我们真的有必要把所有的逻辑运算都用与或非门实现出来吗？这显然是不现实的。

这就好比厨师，你没有听说哪个酒店的厨师专门只做一道菜吗？

最终的成品是比较复杂的，千差万别，但制作每道菜品的方式大同小异，其中包括刀工、颠勺技术等，这些是基本功，制作每道菜品都要经过这些步骤，变化的也无非就是食材、火候、调料的差异，这些放到菜谱中即可，这样给他一个菜谱他就能制作出任意的菜来，在这里厨师就好比硬件，菜谱就好比软件。

![1.你管这破玩意叫CPU？ - 图8](CPU图片/1_8.jpg)

同样的道理，我们没有必要为所有的计算逻辑实现出对应的硬件，硬件只需要提供最基本的功能，最终所有的计算逻辑都通过这些最基本的功能表达出来就好，这就是所谓的软件一词的来源，硬件不可变，但软件可变，因此称为软件，不变的硬件但提供不同的软件就能让硬件提供全新的功能，**无比天才的思想**，人类真的是太聪明了。

同样一台计算机硬件，安装上word你就能编辑文档，安装上VS你就能写代码，安装上游戏你就能玩王者农药，硬件还是那套硬件，提供不同的软件就是实现不同的功能，**每次打开电脑使用各种App时没有在内心高呼一声牛逼你都对不起计算机这么伟大的发明创造**，这就是所谓的通用计算设备，这一 思想是计算机科学的祖师爷图灵提出的。

![1.你管这破玩意叫CPU？ - 图9](CPU图片/1_9.jpg)

扯远了，接下来我们看下硬件是怎么提供所谓的基本功能的。

### 硬件的基本功

让我们来思考一个问题，CPU怎么能知道自己要去对两个数进行加法计算，以及哪两个数进行加法计算呢？

很显然，你得告诉CPU，该怎么告诉呢？还记得上一节中给初始的菜谱吗？没错，CPU也需要一张菜谱告诉自己该接下来该干啥，在这里菜谱就是机器指令，指令通过我们上述实现的组合电路来执行。

接下来我们面临另一个问题，那就是这样的指令应该会很多吧，废话，还是以加法指令为例，你可以让CPU计算1+1，也可以计算1+2等等，实际上单单加法指令就可以有无数中组合，显然CPU不可能去实现所有的指令。

实际上CPU只需要提供**加法操作**，你提供**操作数**就可以了，CPU 说：“我可以打人”，你告诉CPU该打 谁、CPU 说：“我可以唱歌”，你告诉CPU唱什么，CPU 说我可以做饭，你告诉CPU该做什么饭，CPU 说：“我可以炒股”，你告诉CPU快滚一边去吧韭菜。

因此我们可以看到CPU只提供**机制**或者说功能(打人、唱歌、炒菜，加法、减法、跳转)，我们提供**策略**(打谁、歌名、菜名，操作数，跳转地址)。

CPU 表达机制就通过指令集来实现的。

### 指令集与指令执行

指令集告诉我们 CPU 可以执行什么指令，每种指令需要提供什么样的操作数。不同类型的CPU会有不同的指令集。

指令集中的指令其实都非常简单，画风大体上是这样的：

- 从内存中读一个数，地址是abc
- 对两个数加和
- 检查一个数是不是大于6
- 把这数存储到内存，地址是abc
- 等等

看上去很像碎碎念有没有，这就是机器指令，我们用高级语言编写的程序，比如对一个数组进行排序，最终都会等价转换为上面的碎碎念指令，然后 CPU 一条一条的去执行，很神奇有没有。

接下来我们看一条可能的机器指令：

![1.你管这破玩意叫CPU？ - 图10](CPU图片/1_10.jpg)

这条指令占据16比特，其中前四个比特告诉我们这是加法指令，这意味着该CPU的指令集中可以包含 2^4也就是16个机器指令，这四个比特位告诉我们该指令可以做什么，剩下的bite告诉我们该怎么 做，也就是把寄存器R6和寄存器R2中的值相加然后写到寄存器R6中。

可以看到，机器指令是非常繁琐的，现代程序员都使用高级语言来编写程序，关于高级程序语言以及机器指令的话题请参见《你管这破玩意叫编程语言》。

### 指挥家：让我们演奏一曲

现在我们的电路有了计算功能、存储功能，还可以通过指令告诉该电路执行什么操作，还有一个问题没有解决。

我们的电路有很多部分，用来计算的、用来存储的，以最简单的加法为例，假设我们要计算1+1，这两个数分别来自寄存器R1 和 R2，要知道寄存器中可以保存任意值，**我们怎么能确保加法器开始工作 时R1和R2中在这一时刻保存的都是1而不是其它数**？

这个问题就是靠什么来协调靠什么来同步各个部分让它们协同工作呢？就像一场成功的交响乐演出是离不开指挥家，我们的计算组合电路中也需要这样一个指挥家。

![1.你管这破玩意叫CPU？ - 图11](CPU图片/1_11.jpg)

负责指挥角色的就是时钟信号。

时钟信号就像指挥家手里的拿的指挥棒，**指挥棒挥动一下整个乐队会整齐划一的有个相应动作**，同样 的，在时钟信号的每一次电压改变，整个电路中的各个寄存器(也就是整个电路的状态)会更新一下， 这样我们就能确保整个电路协同工作不会这里提到的问题。

现在你应该知道CPU的主频是什么意思了吧，主频是说一秒钟指挥棒挥动了多少次，当然主频越高CPU在一秒内完成的操作也就越多。

### 大功告成

现在我们有了可以完成各种计算的ALU、可以存储信息的寄存器以及控制它们系统工作的时钟信号，这些就是一个极简版的CPU啦。



